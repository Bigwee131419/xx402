<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>x402 å¤©æ°”æ¼”ç¤ºï¼ˆBase + USDCï¼‰</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font:16px/1.5 system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#0d1117; color:#e6edf3; }
    .wrap { max-width:720px; margin:60px auto; padding:24px; }
    h1 { font-weight:700; font-size:26px; margin:0 0 16px; }
    .card { background:#161b22; border:1px solid #30363d; border-radius:12px; padding:16px; }
    .row { display:flex; gap:12px; margin:12px 0; align-items:center; }
    input,button { padding:10px 12px; border-radius:8px; border:1px solid #30363d; background:#0d1117; color:#e6edf3; }
    input { flex:1; }
    button { background:#1f6feb; border:none; cursor:pointer; font-weight:600; }
    button.secondary { background:#21262d; }
    pre { white-space:pre-wrap; background:#0d1117; border:1px dashed #30363d; border-radius:8px; padding:12px; min-height:72px; }
    small{opacity:.75}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸŒ¤ å¤©æ°” API ä»˜è´¹ä½“éªŒï¼ˆx402ï¼‰</h1>

    <div class="card">
      <div class="row">
        <button id="btnConnect">â‘  è¿æ¥é’±åŒ…</button>
        <button id="btnCheck" class="secondary" title="æ£€æŸ¥å½“å‰ç½‘ç»œæ˜¯å¦ä¸º Base ä¸»ç½‘">æ£€æŸ¥ç½‘ç»œ</button>
        <div id="account"><small>é’±åŒ…æœªè¿æ¥</small></div>
      </div>

      <div class="row">
        <label for="baseUrl"><small>åç«¯ API åŸºå€</small></label>
        <input id="baseUrl" value="http://localhost:3000" />
      </div>

      <div class="row">
        <input id="city" placeholder="è¾“å…¥åŸå¸‚ï¼ˆä¾‹å¦‚ï¼šä¸Šæµ·ï¼‰" value="ä¸Šæµ·" />
        <button id="btnFetch">â‘¡ è·å– /weatherï¼ˆè‡ªåŠ¨ä»˜æ¬¾ï¼‰</button>
      </div>

      <pre id="out">ç­‰å¾…æ“ä½œâ€¦</pre>
      <small>æç¤ºï¼šå½“æœåŠ¡è¿”å› 402 æ—¶ï¼Œæœ¬é¡µä¼šåœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€å—ä¿æŠ¤é“¾æ¥ä»¥è§¦å‘ä»˜æ¬¾ï¼›å®Œæˆåä¼šè‡ªåŠ¨è½®è¯¢å¹¶åœ¨æœ¬é¡µå±•ç¤ºç»“æœã€‚</small>
    </div>
  </div>

  <script>
    // Base ä¸»ç½‘ chainId
    const BASE_CHAIN_ID_HEX = '0x2105';

    const $ = (id) => document.getElementById(id);
    const out = $('out');
    const accountEl = $('account');

    let currentAccount = null;

    function log(msg, obj) {
      out.textContent = (typeof msg === 'string' ? msg : JSON.stringify(msg, null, 2))
        + (obj ? '\n' + JSON.stringify(obj, null, 2) : '');
    }

    async function ensureProvider() {
      const injected = window.ethereum;
      if (!injected) {
        alert('æœªæ£€æµ‹åˆ°é’±åŒ…ã€‚è¯·å®‰è£… Coinbase Wallet æˆ– MetaMaskã€‚');
        throw new Error('No wallet injected');
      }

      // å¦‚æœæœ‰å¤šä¸ª providerï¼ˆä¾‹å¦‚ MetaMask / Coinbase / Rabby / Backpackï¼‰ï¼Œä¼˜å…ˆé€‰ MetaMask
      let provider = injected;
      const candidates = injected.providers;
      if (Array.isArray(candidates) && candidates.length) {
        provider =
          candidates.find((p) => p.isMetaMask) ||
          candidates.find((p) => p.isCoinbaseWallet) ||
          candidates[0];
      }
      // ç®€å•è¿é€šæ€§æ£€æŸ¥
      if (!provider.request) {
        throw new Error('Injected provider missing request()');
      }
      return provider;
    }

    async function connectWallet() {
      try {
        const eth = await ensureProvider();
        // è¯·æ±‚è´¦å·
        const accounts = await eth.request({ method: 'eth_requestAccounts' });
        currentAccount = accounts?.[0] || null;
        accountEl.textContent = currentAccount ? `å·²è¿æ¥ï¼š${currentAccount}` : 'é’±åŒ…æœªè¿æ¥';

        // è‹¥ç½‘ç»œä¸æ˜¯ Baseï¼Œåˆ™å°è¯•åˆ‡æ¢/æ·»åŠ 
        const chainId = await eth.request({ method: 'eth_chainId' });
        if (chainId !== BASE_CHAIN_ID_HEX) {
          try {
            await eth.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: BASE_CHAIN_ID_HEX }] });
          } catch (switchErr) {
            // æœªæ·»åŠ åˆ™å°è¯•æ·»åŠ 
            if (switchErr?.code === 4902) {
              await eth.request({
                method: 'wallet_addEthereumChain',
                params: [{
                  chainId: BASE_CHAIN_ID_HEX,
                  chainName: 'Base',
                  nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                  rpcUrls: ['https://mainnet.base.org'],
                  blockExplorerUrls: ['https://basescan.org']
                }]
              });
            } else {
              console.warn('åˆ‡æ¢ç½‘ç»œå¤±è´¥', switchErr);
            }
          }
        }

        log('âœ… é’±åŒ…è¿æ¥æˆåŠŸã€‚è‹¥æŒ‰é’® â‘¡ æ— å“åº”ï¼Œåˆ·æ–°é¡µé¢åå†è¯•ã€‚');
      } catch (err) {
        console.error(err);
        log('âŒ è¿æ¥å¤±è´¥ï¼š' + (err?.message || err));
      }
    }

    async function checkNetwork() {
      try {
        const eth = await ensureProvider();
        const chainId = await eth.request({ method: 'eth_chainId' });
        log(`å½“å‰é“¾ï¼š${chainId}ï¼ˆ${chainId === BASE_CHAIN_ID_HEX ? 'Base ä¸»ç½‘ âœ…' : 'é Baseï¼Œè¯·åˆ‡æ¢'}ï¼‰`);
      } catch (err) {
        log('æ£€æŸ¥å¤±è´¥ï¼š' + (err?.message || err));
      }
    }

    async function fetchWeather() {
      const baseUrl = $('baseUrl').value.trim().replace(/\/$/, '');
      const city = $('city').value.trim() || 'ä¸Šæµ·';
      const url = `${baseUrl}/weather?location=${encodeURIComponent(city)}`;

      log('â³ è¯·æ±‚ï¼š' + url);

      try {
        const res = await fetch(url, { method: 'GET', cache: 'no-store', credentials: 'omit' });

        // æƒ…å†µ 1ï¼šåç«¯ç›´æ¥è¿”å› 200 â€”â€” å·²ç»æœ‰æƒé™ï¼Œç›´æ¥å±•ç¤º
        if (res.ok) {
          const data = await res.json();
          log('âœ… è¿”å›ï¼š\n' + JSON.stringify(data, null, 2));
          return;
        }

        // æƒ…å†µ 2ï¼šè¿”å› 402ï¼Œéœ€è¦è§¦å‘æ”¯ä»˜
        if (res.status === 402) {
          log('ğŸ’³ æ£€æµ‹åˆ° 402ï¼Œéœ€è¦ä»˜æ¬¾ã€‚å·²åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€å—ä¿æŠ¤é“¾æ¥ï¼Œè¯·åœ¨æ–°é¡µå®Œæˆæ”¯ä»˜â€¦');

          // é€šè¿‡â€œå¯¼èˆªâ€è§¦å‘ x402 æ”¯ä»˜é¢æ¿
          const payTab = window.open(url, '_blank');

          // è½®è¯¢ç­‰å¾…åç«¯ä» 402 å˜ä¸º 200
          const timeoutMs = 60_000; // ä¸æœåŠ¡ç«¯çš„ maxTimeoutSeconds å¯¹é½
          const start = Date.now();
          const tick = async () => {
            try {
              const r = await fetch(url, { method: 'GET', cache: 'no-store', credentials: 'omit' });
              if (r.ok) {
                const data = await r.json();
                try { payTab?.close(); } catch {}
                log('âœ… è¿”å›ï¼š\n' + JSON.stringify(data, null, 2));
                return true;
              }
            } catch {}
            return false;
          };

          // å…ˆç­‰ 1s å†å¼€å§‹è½®è¯¢ï¼Œé¿å…ä¸æ–°æ ‡ç­¾é¡µçš„åŠ è½½ç«äº‰
          await new Promise((r) => setTimeout(r, 1000));

          while (Date.now() - start < timeoutMs) {
            // æ¯ 1.2s è½®è¯¢ä¸€æ¬¡
            // eslint-disable-next-line no-await-in-loop
            const ok = await tick();
            if (ok) return;
            // eslint-disable-next-line no-await-in-loop
            await new Promise((r) => setTimeout(r, 1200));
          }

          log('â±ï¸ ç­‰å¾…è¶…æ—¶ï¼šè¯·ç¡®è®¤åœ¨æ–°æ ‡ç­¾é¡µå®Œæˆæ”¯ä»˜åï¼Œè¿”å›æœ¬é¡µé‡æ–°ç‚¹å‡»å°è¯•ã€‚');
          return;
        }

        // å…¶å®ƒé 200/402 é”™è¯¯
        const text = await res.text().catch(() => '');
        log(`HTTP ${res.status}ï¼š${text || 'è¯·ç¨åé‡è¯•'}`);
      } catch (err) {
        console.error(err);
        log('âŒ è¯·æ±‚å‡ºé”™ï¼š' + (err?.message || err));
      }
    }

    // äº‹ä»¶ç»‘å®š
    $('btnConnect').onclick = connectWallet;
    $('btnCheck').onclick = checkNetwork;
    $('btnFetch').onclick = fetchWeather;

    // é’±åŒ…è´¦æˆ·/ç½‘ç»œå˜æ›´ç›‘å¬ï¼ˆå¯é€‰ï¼‰
    if (window.ethereum) {
      window.ethereum.on?.('accountsChanged', (accs) => {
        currentAccount = accs?.[0] || null;
        accountEl.textContent = currentAccount ? `å·²è¿æ¥ï¼š${currentAccount}` : 'é’±åŒ…æœªè¿æ¥';
      });
      window.ethereum.on?.('chainChanged', () => location.reload());
    }
    // å…¼å®¹ä½¿ç”¨ inline onclick çš„æ—§é¡µé¢
    window.connectWallet = connectWallet;      // è¿æ¥é’±åŒ…
    window.getWeather   = fetchWeather;        // è·å–å¤©æ°”ï¼ˆè‡ªåŠ¨ä»˜æ¬¾ï¼‰
    window.getNetwork   = checkNetwork;        // æ£€æŸ¥ç½‘ç»œ
  </script>
</body>
</html>